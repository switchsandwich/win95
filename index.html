<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retro Win95 — Desktop: Minesweeper & Snake</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#008080;
  --win-bg:#c0c0c0;
  --win-border:#000;
  --titlebar:#000080;
  --title-text:#fff;
  --taskbar:#c0c0c0;
  --button-bg:#e0e0e0;
  --mono:'Press Start 2P', monospace;
  --icon-size:72px;
  --cell-size:28px;
}
html,body{height:100%;margin:0;font-family:var(--mono);background:var(--bg);-webkit-font-smoothing:none;overflow:hidden;}
.desktop{position:relative;height:100vh;width:100vw;box-sizing:border-box;}
.icons-area{position:absolute;left:18px;top:18px;right:260px;bottom:84px;pointer-events:auto;}
.icon{position:absolute;width:var(--icon-size);text-align:center;cursor:grab;user-select:none;padding:6px;box-sizing:border-box;}
.icon img{width:48px;height:48px;display:block;margin:0 auto;border:2px solid transparent;}
.icon .label{font-size:11px;margin-top:6px;word-break:break-word;color:#111;}
.icon:active{cursor:grabbing;}
.icon.focus img{border-color:#fff;box-shadow:4px 4px 0 rgba(0,0,0,0.4);}

/* Window */
.win{width:520px;min-height:180px;background:var(--win-bg);border:2px solid var(--win-border);box-shadow:6px 6px 0 rgba(0,0,0,0.4);position:absolute;top:80px;left:80px;user-select:none;display:flex;flex-direction:column;overflow:hidden;}
.titlebar{height:28px;background:var(--titlebar);color:var(--title-text);display:flex;align-items:center;padding:0 6px;gap:6px;box-sizing:border-box;cursor:grab;}
.titlebar .title{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.titlebar .controls{display:flex;gap:4px;}
.btn{width:18px;height:18px;border:2px solid var(--win-border);background:var(--button-bg);display:inline-flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;}
.content{padding:10px;font-size:12px;color:#000;flex:1;overflow:auto;}
textarea{width:100%;height:120px;box-sizing:border-box;font-family:inherit;font-size:12px;resize:vertical;}

/* Taskbar */
.taskbar{position:fixed;left:0;right:0;bottom:0;height:64px;background:var(--taskbar);border-top:2px solid #000;display:flex;align-items:center;gap:8px;padding:8px;box-sizing:border-box;z-index:9999;}
.start{height:48px;min-width:84px;border:2px solid #000;display:flex;align-items:center;padding:6px;gap:8px;background:#e8e8e8;cursor:pointer;user-select:none;}
.start img{height:24px;display:block;}
.start-menu{position:fixed;left:8px;bottom:74px;width:240px;background:var(--win-bg);border:2px solid var(--win-border);display:none;padding:8px;box-shadow:6px 6px 0 rgba(0,0,0,0.4);z-index:9999;}
.start-menu button{display:block;width:100%;margin:6px 0;padding:6px;text-align:left;font-size:12px;cursor:pointer;border:2px solid var(--win-border);background:#e8e8e8;}
#task-buttons{display:flex;gap:6px;flex:1;align-items:center;overflow:auto;padding-left:6px;height:48px;}

/* Minesweeper */
.mines-board{display:grid;gap:2px;user-select:none;justify-content:center;align-items:center;}
.cell{width:var(--cell-size);height:var(--cell-size);display:flex;align-items:center;justify-content:center;border:2px solid #000;background:#d4d0c8;font-weight:700;font-family:var(--mono);cursor:pointer;}
.cell.revealed{background:#e8e8e8;cursor:default;}
.cell.mine.revealed{background:#ff6666;color:#000;}
.cell.flag{background:#f1e;}

/* Snake */
#snake-canvas{background:#111;border:4px solid #000;display:block;margin:8px auto;border-radius:2px;}

/* Utils */
.controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
.small{font-size:11px;padding:6px;border:2px solid #000;background:#e8e8e8;cursor:pointer;}
.hint{position:fixed;right:12px;bottom:84px;background:#fff;padding:8px;border:2px solid #000;border-radius:4px;font-size:11px;opacity:0.95;}
@media (max-width:1000px){ .win{width:90%;left:5%;} .icons-area{right:18px;} }
</style>
</head>
<body>

<div class="desktop" id="desktop">
  <div class="icons-area" id="iconsArea" aria-label="Desktop icons">
    <div class="icon" id="icon-notepad" data-file="notepad" tabindex="0" style="left:0;top:0;">
      <img alt="Notepad" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='%23f3f3f3' stroke='%23000000' stroke-width='2'/><rect x='8' y='10' width='48' height='44' fill='%23ffffff' stroke='%23000000' stroke-width='2'/><rect x='12' y='14' width='40' height='6' fill='%23000000'/></svg>">
      <div class="label">Notepad</div>
    </div>

    <div class="icon" id="icon-game" data-file="game" tabindex="0" style="left:100px;top:0;">
      <img alt="Guess" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='%23f3f3f3' stroke='%23000000' stroke-width='2'/><circle cx='32' cy='28' r='14' fill='%23e07a2d' stroke='%23000000' stroke-width='2'/><text x='32' y='33' font-family='sans-serif' font-size='16' fill='%23fff' text-anchor='middle'>?</text></svg>">
      <div class="label">Guess Number</div>
    </div>

    <div class="icon" id="icon-mines" data-file="mines" tabindex="0" style="left:200px;top:0;">
      <img alt="Mines" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='%23f3f3f3' stroke='%23000000' stroke-width='2'/><g transform='translate(5,5)'><rect x='10' y='10' width='26' height='26' fill='%23b0b0b0' stroke='%23000000' stroke-width='2'/><circle cx='28' cy='28' r='6' fill='%23000000'/></g></svg>">
      <div class="label">Minesweeper</div>
    </div>

    <div class="icon" id="icon-snake" data-file="snake" tabindex="0" style="left:300px;top:0;">
      <img alt="Snake" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='%23f3f3f3' stroke='%23000000' stroke-width='2'/><rect x='14' y='22' width='12' height='12' fill='%2300a000'/><rect x='26' y='22' width='12' height='12' fill='%2300a000'/><rect x='38' y='22' width='12' height='12' fill='%2300a000'/></svg>">
      <div class="label">Snake</div>
    </div>

    <div class="icon" id="icon-developer" data-file="developer" tabindex="0" style="left:400px;top:0;">
      <img alt="Dev" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='%23f3f3f3' stroke='%23000000' stroke-width='2'/><text x='32' y='38' font-family='sans-serif' font-size='18' fill='%23000' text-anchor='middle'>dev</text></svg>">
      <div class="label">Developer</div>
    </div>
  </div>

  <!-- Notepad -->
  <div class="win" id="win-notepad" style="left:40px;top:40px;display:none;">
    <div class="titlebar" data-win="notepad">
      <div class="title">Notepad - notes.txt</div>
      <div class="controls">
        <div class="btn btn-min" data-action="min">—</div>
        <div class="btn btn-close" data-action="close">✕</div>
      </div>
    </div>
    <div class="content">
      <textarea id="notes" placeholder="Напиши что-нибудь..."></textarea>
      <div class="controls-row">
        <button id="save-notes" class="small">Save</button>
        <button id="clear-notes" class="small">Clear</button>
        <div style="flex:1"></div>
        <div style="font-size:11px;color:#333">Saved to localStorage</div>
      </div>
    </div>
  </div>

  <!-- Guess Number -->
  <div class="win" id="win-game" style="left:540px;top:80px;display:none;">
    <div class="titlebar" data-win="game">
      <div class="title">Game - Guess the number</div>
      <div class="controls">
        <div class="btn btn-min" data-action="min">—</div>
        <div class="btn btn-close" data-action="close">✕</div>
      </div>
    </div>
    <div class="content">
      <div>Я загадал число от <strong>1</strong> до <strong>100</strong>. Попробуй угадать!</div>
      <div style="margin-top:8px;">
        <input id="g-input" type="number" min="1" max="100" style="width:120px;padding:6px;font-family:inherit;font-size:12px;" />
        <button id="g-btn" class="small">Угадать</button>
      </div>
      <div id="g-res" style="margin-top:10px;font-weight:700;"></div>
      <div style="margin-top:8px;"><button id="g-new" class="small">Новая игра</button></div>
    </div>
  </div>

  <!-- Minesweeper -->
  <div class="win" id="win-mines" style="left:200px;top:140px;display:none;width:640px;">
    <div class="titlebar" data-win="mines">
      <div class="title">Minesweeper</div>
      <div class="controls">
        <div class="btn btn-min" data-action="min">—</div>
        <div class="btn btn-close" data-action="close">✕</div>
      </div>
    </div>
    <div class="content" id="mines-content">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <label>Difficulty:
          <select id="mines-diff" class="small" style="padding:4px;">
            <option value="beginner">Beginner (9×9, 10)</option>
            <option value="intermediate">Intermediate (16×16, 40)</option>
            <option value="expert">Expert (16×30, 99)</option>
          </select>
        </label>
        <button id="mines-new" class="small">New</button>
        <button id="mines-reset" class="small">Reset</button>
        <div style="flex:1"></div>
        <div id="mines-status" style="font-weight:700"></div>
      </div>
      <div id="mines-board-wrap" style="margin-top:10px;overflow:auto;max-height:420px;"></div>
      <div style="margin-top:8px;font-size:11px;color:#333">Left click to reveal, right click to flag. On touch use Flag Mode.</div>
      <div style="margin-top:6px;">
        <button id="mines-flagmode" class="small">Flag Mode: Off</button>
      </div>
    </div>
  </div>

  <!-- Snake -->
  <div class="win" id="win-snake" style="left:480px;top:220px;display:none;width:420px;">
    <div class="titlebar" data-win="snake">
      <div class="title">Snake</div>
      <div class="controls">
        <div class="btn btn-min" data-action="min">—</div>
        <div class="btn btn-close" data-action="close">✕</div>
      </div>
    </div>
    <div class="content">
      <div style="text-align:center">
        <canvas id="snake-canvas" width="360" height="360"></canvas>
        <div class="controls-row" style="justify-content:center;margin-top:8px">
          <button id="snake-start" class="small">Start</button>
          <button id="snake-pause" class="small">Pause</button>
          <button id="snake-restart" class="small">Restart</button>
          <div style="width:12px"></div>
          <div id="snake-score" style="font-weight:700">Score: 0</div>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#333">Arrows / WASD control. Swipe on mobile.</div>
      </div>
    </div>
  </div>

</div>

<!-- Taskbar -->
<div class="taskbar" id="taskbar">
  <div class="start" id="start-button" aria-haspopup="true" aria-expanded="false" role="button" tabindex="0">
    <img alt="start" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23007acc'/><g fill='%23fff'><rect x='64' y='64' width='160' height='160'/><rect x='288' y='64' width='160' height='160'/><rect x='64' y='288' width='160' height='160'/><rect x='288' y='288' width='160' height='160'/></g></svg>">
    <div>Start</div>
  </div>
  <div id="task-buttons"></div>
</div>

<!-- Start menu -->
<div class="start-menu" id="start-menu" role="menu" aria-hidden="true">
  <button data-open="notepad">Open Notepad</button>
  <button data-open="game">Play Guess Number</button>
  <button data-open="mines">Minesweeper</button>
  <button data-open="snake">Snake</button>
  <button data-open="about">About</button>
</div>

<div class="hint" id="hint" style="display:none">Double-click icon — открыть</div>

<script>
/* =========================
   Utilities: z-index & focus
   ========================= */
let z = 100;
function bringToFront(el){
  z += 1;
  el.style.zIndex = z;
  document.querySelectorAll('.win').forEach(w => w.classList.remove('focus'));
  el.classList.add('focus');
}

/* Drag windows */
function makeDraggable(winEl){
  const title = winEl.querySelector('.titlebar');
  let dragging=false, offsetX=0, offsetY=0;
  function startDrag(clientX, clientY){
    dragging=true; bringToFront(winEl);
    const rect = winEl.getBoundingClientRect();
    offsetX = clientX - rect.left; offsetY = clientY - rect.top;
    title.style.cursor='grabbing';
  }
  function doDrag(clientX, clientY){
    if(!dragging) return;
    let nx = clientX - offsetX, ny = clientY - offsetY;
    const pad = 6;
    const maxX = window.innerWidth - winEl.offsetWidth - pad;
    const maxY = window.innerHeight - winEl.offsetHeight - pad - 64;
    if(nx < pad) nx = pad; if(ny < pad) ny = pad;
    if(nx > maxX) nx = maxX; if(ny > maxY) ny = maxY;
    winEl.style.left = nx + 'px'; winEl.style.top = ny + 'px';
  }
  function endDrag(){ dragging=false; title.style.cursor='grab'; }
  title.addEventListener('mousedown', (e)=>{
    e.preventDefault(); startDrag(e.clientX, e.clientY);
    function mm(ev){ doDrag(ev.clientX, ev.clientY); }
    function mu(){ endDrag(); document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); }
    document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
  });
  title.addEventListener('touchstart', (e)=>{
    if(e.touches.length!==1) return;
    const t = e.touches[0]; startDrag(t.clientX, t.clientY);
    function tm(ev){ const t2 = ev.touches[0]; if(t2) doDrag(t2.clientX, t2.clientY); }
    function te(){ endDrag(); document.removeEventListener('touchmove', tm); document.removeEventListener('touchend', te); }
    document.addEventListener('touchmove', tm, {passive:false}); document.addEventListener('touchend', te);
  });
  winEl.addEventListener('mousedown', ()=> bringToFront(winEl));
}

/* initialize windows */
document.querySelectorAll('.win').forEach((w)=> { makeDraggable(w); createTaskButton(w); });

/* Taskbar buttons */
const taskButtons = document.getElementById('task-buttons');
function createTaskButton(winEl){
  const id = winEl.id; const name = winEl.querySelector('.title').innerText;
  const btn = document.createElement('button');
  btn.className = 'task-btn'; btn.textContent = name; btn.dataset.for = id;
  btn.addEventListener('click', ()=> {
    if(winEl.style.display === 'none' || getComputedStyle(winEl).display === 'none'){ winEl.style.display = 'flex'; bringToFront(winEl); }
    else { winEl.style.display = 'none'; }
  });
  taskButtons.appendChild(btn);
}

/* Window controls */
document.querySelectorAll('.win .btn').forEach(b => {
  b.addEventListener('click', (e)=>{
    const act = b.dataset.action; const win = b.closest('.win');
    if(act === 'close'){ win.style.display = 'none'; }
    else if(act === 'min'){ win.style.display = 'none'; }
    e.stopPropagation();
  });
});

/* Start menu */
const startButton = document.getElementById('start-button');
const startMenu = document.getElementById('start-menu');
startButton.addEventListener('click', () => {
  const vis = startMenu.style.display === 'block';
  startMenu.style.display = vis ? 'none' : 'block';
  startButton.setAttribute('aria-expanded', String(!vis));
});
document.addEventListener('click', (e)=> {
  if(!startMenu.contains(e.target) && !startButton.contains(e.target)) startMenu.style.display = 'none';
});
startMenu.querySelectorAll('button[data-open]').forEach(b => b.addEventListener('click', ()=> { openWindow(b.dataset.open); startMenu.style.display='none'; }));

/* openWindow helper */
function openWindow(name){
  if(name === 'developer'){ window.open('https://switchsandwich.github.io', '_blank', 'noopener'); return; }
  const map = { notepad:'win-notepad', game:'win-game', mines:'win-mines', snake:'win-snake', about:'win-about' };
  const id = map[name];
  if(!id) return;
  const w = document.getElementById(id);
  if(!w) return;
  w.style.display = 'flex'; bringToFront(w);
}

/* Icons drag + save positions */
const iconsArea = document.getElementById('iconsArea');
const icons = Array.from(document.querySelectorAll('.icon'));
const ICONS_KEY = 'win95_icons_pos_v2';
function loadIconPositions(){
  try{
    const raw = localStorage.getItem(ICONS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    icons.forEach(ic => {
      const pos = obj[ic.id];
      if(pos && typeof pos.x === 'number' && typeof pos.y === 'number'){
        ic.style.left = pos.x + 'px'; ic.style.top = pos.y + 'px';
      }
    });
  }catch(e){ console.warn('load pos err', e); }
}
function saveIconPositions(){
  const obj = {};
  icons.forEach(ic => { obj[ic.id] = { x: parseInt(ic.style.left || 0,10), y: parseInt(ic.style.top || 0,10) }; });
  localStorage.setItem(ICONS_KEY, JSON.stringify(obj));
}
loadIconPositions();

icons.forEach(ic => {
  // keyboard open / move
  ic.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ openIcon(ic); e.preventDefault(); }
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      const step = e.shiftKey ? 20 : 10;
      let x = parseInt(ic.style.left||0,10), y = parseInt(ic.style.top||0,10);
      if(e.key==='ArrowLeft') x -= step;
      if(e.key==='ArrowRight') x += step;
      if(e.key==='ArrowUp') y -= step;
      if(e.key==='ArrowDown') y += step;
      ic.style.left = Math.max(6, Math.min(window.innerWidth - 140, x)) + 'px';
      ic.style.top = Math.max(6, Math.min(window.innerHeight - 160, y)) + 'px';
      saveIconPositions(); e.preventDefault();
    }
  });

  // mouse drag
  let dragging=false, startX=0, startY=0, origX=0, origY=0;
  ic.addEventListener('mousedown', (e)=>{
    // start dragging only if not a double click (we still handle double below)
    dragging=true; ic.classList.add('focus');
    startX = e.clientX; startY = e.clientY; origX = parseInt(ic.style.left||0,10); origY = parseInt(ic.style.top||0,10);
    function mm(ev){ if(!dragging) return; const nx = origX + (ev.clientX - startX); const ny = origY + (ev.clientY - startY);
      ic.style.left = Math.max(6, Math.min(window.innerWidth - 140, nx)) + 'px';
      ic.style.top = Math.max(6, Math.min(window.innerHeight - 160, ny)) + 'px';
    }
    function mu(){ dragging=false; ic.classList.remove('focus'); saveIconPositions(); document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); }
    document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    e.preventDefault();
  });

  // touch drag
  ic.addEventListener('touchstart', (e)=>{
    if(e.touches.length !== 1) return;
    const t = e.touches[0];
    dragging = true; ic.classList.add('focus');
    startX = t.clientX; startY = t.clientY; origX = parseInt(ic.style.left||0,10); origY = parseInt(ic.style.top||0,10);
    function tm(ev){ const t2 = ev.touches[0]; if(!t2) return; const nx = origX + (t2.clientX - startX); const ny = origY + (t2.clientY - startY);
      ic.style.left = Math.max(6, Math.min(window.innerWidth - 140, nx)) + 'px';
      ic.style.top = Math.max(6, Math.min(window.innerHeight - 160, ny)) + 'px';
    }
    function te(){ dragging=false; ic.classList.remove('focus'); saveIconPositions(); document.removeEventListener('touchmove', tm); document.removeEventListener('touchend', te); }
    document.addEventListener('touchmove', tm, {passive:false}); document.addEventListener('touchend', te);
    e.preventDefault();
  });

  // double click handling
  let clicks = 0, timer = null;
  ic.addEventListener('click', (e)=>{
    clicks++;
    if(clicks === 1){
      timer = setTimeout(()=>{ clicks = 0; clearTimeout(timer); timer=null; }, 350);
    } else if(clicks === 2){
      openIcon(ic); clicks = 0; if(timer){ clearTimeout(timer); timer=null; }
    }
  });
});

function openIcon(ic){
  const file = ic.dataset.file;
  if(file === 'developer'){ window.open('https://switchsandwich.github.io', '_blank', 'noopener'); return; }
  if(file === 'mines') openWindow('mines');
  else if(file === 'snake') openWindow('snake');
  else if(file === 'notepad') openWindow('notepad');
  else if(file === 'game') openWindow('game');
}

/* hint */
const hint = document.getElementById('hint');
let hintTimer = setTimeout(()=>{ hint.style.display = 'block'; }, 1200);
document.getElementById('desktop').addEventListener('mousemove', ()=>{ hint.style.display='none'; if(hintTimer){ clearTimeout(hintTimer); hintTimer=null; } });

/* Notepad save/load */
const notesEl = document.getElementById('notes');
const saveBtn = document.getElementById('save-notes');
const clearBtn = document.getElementById('clear-notes');
const NOTEPAD_KEY = 'win95_notes_v1';
window.addEventListener('load', ()=> {
  const saved = localStorage.getItem(NOTEPAD_KEY); if(saved) notesEl.value = saved;
});
saveBtn.addEventListener('click', ()=> {
  const v = notesEl.value; localStorage.setItem(NOTEPAD_KEY, v);
  saveBtn.textContent = 'Saved ✓'; setTimeout(()=> saveBtn.textContent = 'Save', 900);
});
clearBtn.addEventListener('click', ()=> { notesEl.value=''; localStorage.removeItem(NOTEPAD_KEY); });

/* Guess number */
let secret = Math.floor(Math.random()*100)+1;
const inEl = document.getElementById('g-input');
const btnGuess = document.getElementById('g-btn');
const outEl = document.getElementById('g-res');
const newBtn = document.getElementById('g-new');
btnGuess.addEventListener('click', ()=>{
  const v = Number(inEl.value);
  if(!v || v<1 || v>100){ outEl.textContent = 'Введите число 1–100'; return; }
  if(v===secret){ outEl.textContent = 'Правильно! 🎉'; }
  else if(v < secret) outEl.textContent = 'Больше →';
  else outEl.textContent = 'Меньше ←';
});
newBtn.addEventListener('click', ()=>{ secret = Math.floor(Math.random()*100)+1; outEl.textContent='Новая игра!'; inEl.value=''; });

/* =========================
   MINESWEEPER IMPLEMENTATION
   ========================= */
const minesWrap = document.getElementById('mines-board-wrap');
const minesStatus = document.getElementById('mines-status');
const minesNew = document.getElementById('mines-new');
const minesReset = document.getElementById('mines-reset');
const minesDiff = document.getElementById('mines-diff');
const minesFlagModeBtn = document.getElementById('mines-flagmode');

let minesState = null;
let minesFlagMode = false;

function newMines(difficulty){
  let rows, cols, mines;
  if(difficulty==='beginner'){ rows=9; cols=9; mines=10; }
  else if(difficulty==='intermediate'){ rows=16; cols=16; mines=40; }
  else { rows=16; cols=30; mines=99; }
  minesState = { rows, cols, mines, started:false, gameOver:false, flagsLeft:mines, revealedCount:0, cells:[] };
  for(let r=0;r<rows;r++){
    const row=[];
    for(let c=0;c<cols;c++) row.push({ mine:false, revealed:false, flagged:false, adj:0 });
    minesState.cells.push(row);
  }
  renderMines();
  updateMinesStatus();
}

function placeMinesAvoid(firstR, firstC){
  const {rows,cols,mines,cells} = minesState;
  let placed = 0;
  const excluded = new Set();
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    const rr = firstR+dr, cc = firstC+dc;
    if(rr>=0 && rr<rows && cc>=0 && cc<cols) excluded.add(rr+'_'+cc);
  }
  while(placed < mines){
    const r = Math.floor(Math.random()*rows);
    const c = Math.floor(Math.random()*cols);
    const key = r+'_'+c;
    if(excluded.has(key)) continue;
    if(cells[r][c].mine) continue;
    cells[r][c].mine = true; placed++;
  }
  // adj counts
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(cells[r][c].mine){ cells[r][c].adj = -1; continue; }
      let adj=0;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        if(dr===0 && dc===0) continue;
        const rr=r+dr, cc=c+dc;
        if(rr>=0 && rr<rows && cc>=0 && cc<cols && cells[rr][cc].mine) adj++;
      }
      cells[r][c].adj = adj;
    }
  }
}

function revealAllMines(explodeR, explodeC){
  const st = minesState;
  for(let r=0;r<st.rows;r++){
    for(let c=0;c<st.cols;c++){
      const cell = st.cells[r][c];
      const el = document.querySelector(`[data-r='${r}'][data-c='${c}']`);
      if(cell.mine){
        el.classList.add('revealed','mine');
        el.textContent = '💣';
      } else {
        if(cell.adj>0) el.textContent = cell.adj;
        el.classList.add('revealed');
      }
    }
  }
  if(typeof explodeR === 'number'){
    const e = document.querySelector(`[data-r='${explodeR}'][data-c='${explodeC}']`);
    if(e) e.style.background = '#ff4d4d';
  }
}

function floodReveal(r,c){
  const st = minesState;
  const q = [[r,c]];
  const seen = new Set();
  while(q.length){
    const [cr,cc] = q.shift();
    const key = cr+'_'+cc;
    if(seen.has(key)) continue; seen.add(key);
    const cell = st.cells[cr][cc];
    const el = document.querySelector(`[data-r='${cr}'][data-c='${cc}']`);
    if(!cell.revealed && !cell.flagged){
      cell.revealed = true; st.revealedCount++;
      el.classList.add('revealed');
      if(cell.adj>0) el.textContent = cell.adj;
      else el.textContent = '';
    }
    if(cell.adj === 0){
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        const rr=cr+dr, cc=cc=cc=cc; // placeholder fix below
      }
    }
  }
}
// above loop had a small slip; rewrite floodReveal correctly
function floodRevealFixed(r,c){
  const st = minesState;
  const q = [[r,c]];
  const seen = new Set();
  while(q.length){
    const [cr,cc] = q.shift();
    const key = cr+'_'+cc;
    if(seen.has(key)) continue; seen.add(key);
    const cell = st.cells[cr][cc];
    const el = document.querySelector(`[data-r='${cr}'][data-c='${cc}']`);
    if(!cell.revealed && !cell.flagged){
      cell.revealed = true; st.revealedCount++;
      el.classList.add('revealed');
      if(cell.adj>0) el.textContent = cell.adj;
      else el.textContent = '';
    }
    if(cell.adj === 0){
      for(let dr=-1;dr<=1;dr++){
        for(let dc=-1;dc<=1;dc++){
          const rr = cr+dr, cc2 = cc+dc;
          if(rr>=0 && rr<st.rows && cc2>=0 && cc2<st.cols){
            const ch = st.cells[rr][cc2];
            if(!ch.revealed && !ch.flagged && !ch.mine){
              q.push([rr,cc2]);
            }
          }
        }
      }
    }
  }
}

function revealCell(r,c){
  const st = minesState;
  if(st.gameOver) return;
  const cell = st.cells[r][c];
  const el = document.querySelector(`[data-r='${r}'][data-c='${c}']`);
  if(cell.revealed || cell.flagged) return;
  if(!st.started){
    placeMinesAvoid(r,c);
    st.started = true;
  }
  if(cell.mine){
    st.gameOver = true;
    revealAllMines(r,c);
    minesStatus.textContent = 'BOOM! Game Over';
    return;
  }
  if(cell.adj === 0){
    floodRevealFixed(r,c);
  } else {
    cell.revealed = true; st.revealedCount++;
    el.classList.add('revealed'); el.textContent = cell.adj;
  }
  checkMinesWin();
  updateMinesStatus();
}

function toggleFlag(r,c){
  const st = minesState;
  if(st.gameOver || st.cells[r][c].revealed) return;
  const cell = st.cells[r][c];
  const el = document.querySelector(`[data-r='${r}'][data-c='${c}']`);
  if(cell.flagged){ cell.flagged = false; el.classList.remove('flag'); el.textContent = ''; st.flagsLeft++; }
  else { if(st.flagsLeft<=0) return; cell.flagged = true; el.classList.add('flag'); el.textContent = '⚑'; st.flagsLeft--; }
  updateMinesStatus();
  checkMinesWin();
}

function checkMinesWin(){
  const st = minesState;
  const total = st.rows*st.cols;
  if(st.revealedCount === total - st.mines && !st.gameOver){
    st.gameOver = true;
    minesStatus.textContent = 'You win! 🎉';
    // reveal all mines as flags
    for(let r=0;r<st.rows;r++) for(let c=0;c<st.cols;c++){
      const cell = st.cells[r][c]; const el = document.querySelector(`[data-r='${r}'][data-c='${c}']`);
      if(cell.mine){ el.classList.add('flag'); el.textContent = '⚑'; }
    }
  }
}

function updateMinesStatus(){
  if(!minesState) return;
  minesStatus.textContent = `Mines: ${minesState.mines}  Flags left: ${minesState.flagsLeft}`;
}

function renderMines(){
  const st = minesState;
  minesWrap.innerHTML = '';
  const board = document.createElement('div');
  board.className = 'mines-board';
  const cs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size')) || 28;
  board.style.gridTemplateColumns = `repeat(${st.cols}, ${cs}px)`;
  // create cells
  for(let r=0;r<st.rows;r++){
    for(let c=0;c<st.cols;c++){
      const el = document.createElement('div');
      el.className = 'cell';
      el.dataset.r = r; el.dataset.c = c;
      el.addEventListener('click', (e)=> {
        if(minesFlagMode){ toggleFlag(r,c); return; }
        revealCell(r,c);
      });
      el.addEventListener('contextmenu', (e)=> {
        e.preventDefault(); toggleFlag(r,c);
      });
      board.appendChild(el);
    }
  }
  minesWrap.appendChild(board);
  updateMinesStatus();
}

/* mines controls */
minesNew.addEventListener('click', ()=> { newMines(minesDiff.value); });
minesReset.addEventListener('click', ()=> {
  if(!minesState) return;
  // reset to same difficulty
  const diff = minesDiff.value;
  newMines(diff);
});
minesDiff.addEventListener('change', ()=> { newMines(minesDiff.value); });
minesFlagModeBtn.addEventListener('click', ()=>{
  minesFlagMode = !minesFlagMode;
  minesFlagModeBtn.textContent = 'Flag Mode: ' + (minesFlagMode ? 'On' : 'Off');
});

/* initialize default */
newMines('beginner');

/* =========================
   SNAKE IMPLEMENTATION
   ========================= */
const canvas = document.getElementById('snake-canvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('snake-score');
const btnStart = document.getElementById('snake-start');
const btnPause = document.getElementById('snake-pause');
const btnRestart = document.getElementById('snake-restart');

let gridCount = 20; // 20x20
let cellSize = Math.floor(canvas.width / gridCount);
let snake = [{x:10,y:10}];
let dir = {x:0,y:0};
let food = {x:15,y:15};
let gameInterval = null;
let speed = 120; // ms per step
let running = false;
let score = 0;

function resetSnake(){
  gridCount = 20;
  cellSize = Math.floor(canvas.width / gridCount);
  snake = [{x:10,y:10}];
  dir = {x:0,y:0};
  placeFood();
  running = false; score = 0; updateScore();
  drawSnake();
}

function placeFood(){
  const max = gridCount;
  let ok=false;
  while(!ok){
    const fx = Math.floor(Math.random()*max);
    const fy = Math.floor(Math.random()*max);
    ok = !snake.some(s => s.x===fx && s.y===fy);
    if(ok){ food.x = fx; food.y = fy; }
  }
}

function drawSnake(){
  // clear
  ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
  // draw food
  ctx.fillStyle = '#ff0000'; ctx.fillRect(food.x*cellSize, food.y*cellSize, cellSize, cellSize);
  // draw snake
  ctx.fillStyle = '#00ff66';
  snake.forEach((s, idx) => {
    ctx.fillRect(s.x*cellSize, s.y*cellSize, cellSize-1, cellSize-1);
  });
}

function stepSnake(){
  if(dir.x===0 && dir.y===0) return;
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
  // wrap-around or collision? We'll wrap-around
  if(head.x < 0) head.x = gridCount - 1;
  if(head.x >= gridCount) head.x = 0;
  if(head.y < 0) head.y = gridCount - 1;
  if(head.y >= gridCount) head.y = 0;
  // check collision with body
  if(snake.some(s=>s.x===head.x && s.y===head.y)){
    // game over
    running = false; clearInterval(gameInterval); gameInterval = null;
    alert('Game over! Score: ' + score);
    return;
  }
  snake.unshift(head);
  // eat food
  if(head.x === food.x && head.y === food.y){
    score += 1; updateScore(); placeFood();
  } else {
    snake.pop();
  }
  drawSnake();
}

function startSnake(){
  if(running) return;
  running = true;
  gameInterval = setInterval(stepSnake, speed);
}
function pauseSnake(){
  if(gameInterval){ clearInterval(gameInterval); gameInterval = null; running=false; }
}
function restartSnake(){
  pauseSnake(); resetSnake(); startSnake();
}
function updateScore(){ scoreEl.textContent = 'Score: ' + score; }

document.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if(k === 'arrowup' || k === 'w'){ if(dir.y!==1) dir = {x:0,y:-1}; }
  if(k === 'arrowdown' || k === 's'){ if(dir.y!==-1) dir = {x:0,y:1}; }
  if(k === 'arrowleft' || k === 'a'){ if(dir.x!==1) dir = {x:-1,y:0}; }
  if(k === 'arrowright' || k === 'd'){ if(dir.x!==-1) dir = {x:1,y:0}; }
});

btnStart.addEventListener('click', ()=> startSnake());
btnPause.addEventListener('click', ()=> pauseSnake());
btnRestart.addEventListener('click', ()=> { resetSnake(); startSnake(); });

/* simple swipe for mobile */
let touchStartX=0, touchStartY=0;
canvas.addEventListener('touchstart', (e)=>{ const t = e.touches[0]; touchStartX = t.clientX; touchStartY = t.clientY; });
canvas.addEventListener('touchend', (e)=> {
  const t = e.changedTouches[0]; const dx = t.clientX - touchStartX, dy = t.clientY - touchStartY;
  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 20 && dir.x!==-1) dir = {x:1,y:0};
    if(dx < -20 && dir.x!==1) dir = {x:-1,y:0};
  } else {
    if(dy > 20 && dir.y!==-1) dir = {x:0,y:1};
    if(dy < -20 && dir.y!==1) dir = {x:0,y:-1};
  }
});

/* initialize snake */
resetSnake();
drawSnake();

/* Accessibility & initial setup */
function isTouchDevice(){ return ('ontouchstart' in window) || navigator.maxTouchPoints>0 || navigator.msMaxTouchPoints>0; }
if(isTouchDevice()) document.documentElement.classList.add('touch');

/* prevent default context menu on mines area */
document.addEventListener('contextmenu', function(e){
  // allow default elsewhere
  if(e.target && e.target.closest && e.target.closest('.mines-board')) e.preventDefault();
}, false);

/* Make About window (simple) */
const aboutWin = document.createElement('div');
aboutWin.className = 'win'; aboutWin.id = 'win-about';
aboutWin.style.left = '120px'; aboutWin.style.top = '120px'; aboutWin.style.display = 'none';
aboutWin.innerHTML = `<div class="titlebar" data-win="about"><div class="title">About</div><div class="controls"><div class="btn btn-min" data-action="min">—</div><div class="btn btn-close" data-action="close">✕</div></div></div><div class="content"><p>Retro Windows95-style demo.<br>Minesweeper & Snake built-in.</p><p>Developer link opens switchsandwich.github.io</p></div>`;
document.body.appendChild(aboutWin);
makeDraggable(aboutWin);
createTaskButton(aboutWin);

/* ensure windows positioned correctly on load */
window.addEventListener('load', ()=> {
  document.querySelectorAll('.win').forEach((w, i)=> {
    if(!w.style.left) w.style.left = (40 + i*20) + 'px';
    if(!w.style.top) w.style.top = (40 + i*20) + 'px';
  });
});
</script>

</body>
</html>
